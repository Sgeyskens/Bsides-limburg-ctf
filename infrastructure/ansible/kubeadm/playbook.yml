---
- name: Kubernetes HA Cluster with kubeadm
  hosts: k8s_cluster
  become: true
  vars_files:
    - variables.yml

  tasks:
  ####################################################################
  # WRITE HOSTS FILE
  ####################################################################
  - name: Add all cluster hosts to /etc/hosts with custom hostnames
    ansible.builtin.lineinfile:
      path: /etc/hosts
      line: "{{ item }} {{ hostvars[item].custom_hostname }}"
      state: present
    loop: "{{ groups['k8s_cluster'] }}"

  ####################################################################
  # PREREQUISITES
  ####################################################################
  - name: Disable swap
    mount:
      name: swap
      fstype: swap
      state: absent

  - name: Turn off swap
    command: swapoff -a
    when: ansible_swaptotal_mb > 0

  - name: Load kernel modules
    modprobe:
      name: "{{ item }}"
      state: present
    loop:
      - overlay
      - br_netfilter

  - name: Apply sysctl settings
    sysctl:
      name: "{{ item.key }}"
      value: "{{ item.value }}"
      state: present
      reload: yes
    loop:
      - { key: 'net.bridge.bridge-nf-call-iptables', value: 1 }
      - { key: 'net.bridge.bridge-nf-call-ip6tables', value: 1 }
      - { key: 'net.ipv4.ip_forward', value: 1 }


  ####################################################################
  # CONTAINERD
  ####################################################################

  - name: Install containerd
    apt:
      name: containerd
      state: present
      update_cache: false

  - name: Configure containerd
    shell: |
      mkdir -p /etc/containerd
      containerd config default > /etc/containerd/config.toml
      sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
      sed -i 's#sandbox_image = ".*"#sandbox_image = "registry.k8s.io/pause:3.9"#' /etc/containerd/config.toml

  - name: Restart containerd
    systemd:
      name: containerd
      enabled: true
      state: restarted

  ####################################################################
  # KUBERNETES PACKAGES - Modern pkgs.k8s.io method (2026)
  ####################################################################

  - name: Install prerequisites
    become: true
    ansible.builtin.apt:
      pkg:
        - ca-certificates
        - curl
        - gnupg
      state: present
      update_cache: yes

  - name: Ensure /etc/apt/keyrings directory exists
    become: true
    ansible.builtin.file:
      path: /etc/apt/keyrings
      state: directory
      mode: '0755'

  - name: Remove any stale/invalid Kubernetes GPG key (cleanup for reliability)
    become: true
    ansible.builtin.file:
      path: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      state: absent
    when: ansible_check_mode == false  # optional: skip in --check

  - name: Download and dearmor Kubernetes GPG key for minor version {{ kubernetes_version_minor }}
    become: true
    ansible.builtin.shell: >
      curl -fsSL https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version_minor }}/deb/Release.key
      | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    args:
      creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

  - name: Set correct permissions on the GPG key
    become: true
    ansible.builtin.file:
      path: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      mode: '0644'

  - name: Add Kubernetes apt repository for minor version {{ kubernetes_version_minor }}
    become: true
    ansible.builtin.apt_repository:
      repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version_minor }}/deb/ /"
      state: present
      filename: kubernetes
      update_cache: yes

  - name: Install exact version of kubeadm, kubelet, kubectl (pinned to {{ kubernetes_version }})
    become: true
    ansible.builtin.apt:
      name:
        - "kubelet={{ kubernetes_version }}*"
        - "kubeadm={{ kubernetes_version }}*"
        - "kubectl={{ kubernetes_version }}*"
      state: present
      update_cache: yes

  - name: Hold Kubernetes packages at exact version
    become: true
    ansible.builtin.command: apt-mark hold kubelet kubeadm kubectl
    changed_when: false

  - name: Enable and start kubelet service
    become: true
    ansible.builtin.systemd:
      name: kubelet
      enabled: true
      state: started

####################################################################
# HELM INSTALLATION VIA OFFICIAL SCRIPT
####################################################################

  - name: Download Helm install script
    ansible.builtin.get_url:
      url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-4
      dest: /tmp/get_helm.sh
      mode: '0700'

  - name: Run Helm install script
    ansible.builtin.command: /tmp/get_helm.sh
    args:
      creates: /usr/local/bin/helm



####################################################################
# INITIALIZE FIRST CONTROL PLANE
####################################################################

- name: Initialize first control plane
  hosts: masters[0]
  become: true
  vars_files:
    - variables.yml

  tasks:
  - name: Initialize cluster
    ansible.builtin.command: >
      kubeadm init
      --control-plane-endpoint {{ control_plane_endpoint }}
      --upload-certs
      --pod-network-cidr {{ pod_network_cidr }}
      --kubernetes-version v{{ kubernetes_version }}
      --apiserver-advertise-address {{ ansible_host }}
    args:
      creates: /etc/kubernetes/admin.conf

  - name: Ensure .kube directory exists
    ansible.builtin.file:
      path: /root/.kube
      state: directory
      mode: '0700'

  - name: Copy admin.conf to root kubeconfig
    ansible.builtin.copy:
      src: /etc/kubernetes/admin.conf
      dest: /root/.kube/config
      owner: root
      group: root
      mode: '0600'
      remote_src: true

  - name: Upload certs and extract certificate key
    ansible.builtin.command: kubeadm init phase upload-certs --upload-certs
    register: cert_upload
    changed_when: "'certificate key' in cert_upload.stdout"

  - name: Extract certificate key
    ansible.builtin.set_fact:
      certificate_key: "{{ cert_upload.stdout_lines | last }}"

  - name: Generate control-plane join command
    ansible.builtin.command: >
      kubeadm token create --print-join-command
      --certificate-key {{ certificate_key }}
    register: cp_join_cmd

  - name: Generate worker join command
    ansible.builtin.command: kubeadm token create --print-join-command
    register: worker_join_cmd

  - name: Save join commands to hostvars
    ansible.builtin.set_fact:
      cp_join: "{{ cp_join_cmd.stdout }}"
      worker_join: "{{ worker_join_cmd.stdout }}"

  - name: Safety net â€“ ensure kubernetes-admin is cluster-admin
    ansible.builtin.command: >
      kubectl create clusterrolebinding kubernetes-admin-binding
      --clusterrole=cluster-admin
      --user=kubernetes-admin
    environment:
      KUBECONFIG: /etc/kubernetes/admin.conf
    register: rbac_fix
    failed_when: false
    changed_when: "'created' in rbac_fix.stdout"

  - name: Install CNI (Calico)
    ansible.builtin.command: kubectl apply -f {{ cni_manifest }}
    environment:
      KUBECONFIG: /etc/kubernetes/admin.conf

- name: Join additional control planes
  hosts: masters[1:]
  become: true
  vars_files:
    - variables.yml

  tasks:
  - name: Join control plane
    ansible.builtin.command: "{{ hostvars[groups['masters'][0]].cp_join }} --control-plane --apiserver-advertise-address {{ ansible_host }}"
    args:
      creates: /etc/kubernetes/kubelet.conf

- name: Join worker nodes
  hosts: workers
  become: true
  vars_files:
    - variables.yml

  tasks:
  - name: Join worker
    ansible.builtin.command: "{{ hostvars[groups['masters'][0]].worker_join }}"
    args:
      creates: /etc/kubernetes/kubelet.conf
